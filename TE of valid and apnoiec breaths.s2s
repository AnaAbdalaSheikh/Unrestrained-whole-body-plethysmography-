
Var res%; 'Result view handle

Var txt%; 'Text view handle

var fileok%;

View (app (3));
WindowVisible (0);

'setting toolbar buttons
ToolbarSet (1,"Del Sel Chan",delchan%);
ToolbarSet (2,"Hide Sel Chan",hide%);
ToolbarSet (3,"Quit Script",abort%);
Toolbarset (4,"Save Sel Chan",save%);
ToolbarSet (5,"Get Text",gettxt%);
ToolbarSet (6,"Get File",getdata%);
ToolbarSet (7,"Point channels",Dialog%);
ToolbarSet (8, "TE of valid and apnoeic breaths",TEVAB%);

Toolbar ("IP: Ana Paula Abdala Sheikh, 2021", 1023);

Halt;

'Open an experiment file***********************************

Func getdata%();

res%:=FileOpen ("",0,11);
Window (0,0,70,100);
fileok%:=1;
    
Fix%();

Return 1;
End;

var filename1$;

Func Fix%(); ' changes the display configuration to save time

if res%>0 then View (res%);
    
    XAxisStyle(2, 0, 0);
    XAxisAttrib(0);
    XRange(0, MaxTime());
    FrontView(res%);
    filename1$:=FileName$(0);
    
    HCursorDelete(-1);
    HCursorNew(1, 0.0); ' place a horizontal cursor on zero flow
    HCursorLabel(0);
    
endif;

Return 1;
End;

'Open a text file*****************************
Func gettxt%();
var file%;

file%:=Interact("Choose an option",1023,0,"Open a new file","Open an existing file");

if file%=1 then;
    txt%:=FileNew(1,1);
    Window (70,0,100,100);
endif;

if file%=2 then;    
    txt%:=FileOpen ("",1,11);
    Window (70,0,100,100);
endif

fileok%:=1;
Return 1;
End;

'Hide selected channels*******************************
Func hide%();

View(Res%); 'Point to the result view
ChanHide (-3);

fileok%:=1;
Return 1
End

'Delete selected channels*******************************
Func delchan%();

View(Res%); 'Point to the result view
ChanDelete (-3,1);

fileok%:=1;
Return 1
End

'Save selected memory channels**************************

Func save%();

View (res%);
ChanSave(-3,0);
Message("Selected channels saved");

Return 1
End


'Stop running script*********************************************

Func abort%();

Halt;
End

'Determine parameters for breath detection***********************

var chTE%:=3;      'channel holding TE values for apnoeas generated by running script WBU-plethysmography_mice (6)
var chTEVAB%:=26;     'channel holding markers for valid and apnoeic breaths
var T1:=1800;
var T2:=5400;
var T3:=9000;
var T4:=12600;

Func Dialog%();

var ok%,ratio;

View(res%);

DlgCreate("Channels needed for analysis");  'Start new dialog
DlgAllow(1023);
DlgChan(1,"Channel containing all TE values",64);
DlgChan(2,"Marker channel for valid and apnoeic breaths",8);
DlgReal(3,"First time point (sec)",0,100000); 
DlgReal(4,"Second time point (sec)",0,100000); 
DlgReal(5,"Third time point (sec)",0,100000); 
DlgReal(6,"Fourth time point (sec)",0,100000); 
DlgButton(0,"Cancel");
DlgButton(1,"OK");
ok%:= DlgShow(chTE%,chTEVAB%, T1, T2, T3, T4);

If ok%=0 then
    Message("Something went wrong");
	return 1;
Endif

If ok%>0 then
    
    Do%();
    
    ChanHide(-1);
    ChanShow(1,chTE%,chTEVAB%);
    DrawMode(chTE%,3,4, 0,1); 'Set Waveform
    MarkShow(chTE%, 0, 0); 'Set marker to display and mode
      
    return 1
endif

end

' Set active cursor mode for cursor zero

Func Do%();

View(res%);

CursorDelete(-1);

CursorSet(0);
Cursor(0, XLow()*0.7+XHigh()*0.3);  'Fetch the cursor
CursorVisible(0, 1);  'Show the cursor
CursorLabel(2,0);

CursorActive(0,14, chTEVAB%, 0, "", "", 1);   'Data points

fileok%:=1;
Return 1;
End;


Func TEVAB%(); 'create XY views containing TE values foe valid and apnoeic breaths at 1-2 hr, 2-3hr, 3-4hr post-treatment

MeasureToXY(14, chTEVAB%, 0, 1, 0, 1);
MeasureX(102, 0, "Cursor(0)", "0");
MeasureY(100, chTE%, "Cursor(0)", "0");
MeasureChan(1,"TE values",0);
WindowVisible(1);
Process(T1, T2, 0, 1);

MeasureToXY(14, chTEVAB%, 0, 1, 0, 1);
MeasureX(102, 0, "Cursor(0)", "0");
MeasureY(100, chTE%, "Cursor(0)", "0");
MeasureChan(1,"TE values",0);
WindowVisible(1);
Process(T2, T3, 0, 1);

MeasureToXY(14, chTEVAB%, 0, 1, 0, 1);
MeasureX(102, 0, "Cursor(0)", "0");
MeasureY(100, chTE%, "Cursor(0)", "0");
MeasureChan(1,"TE values",0);
WindowVisible(1);
Process(T3, T4, 0, 1);

fileok%:=1;
Return 1;
End;
